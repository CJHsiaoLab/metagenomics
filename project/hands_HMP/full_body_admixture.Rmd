---
title: 'Cluster comparison Admixture: HMP data'
author: "Kushal K Dey"
date: "November 6, 2015"
output: html_document
---
```{r packages, message = FALSE, warning = FALSE}
library(metagenomeSeq)
library(maptpx)
library(tsne)
library(qtlcharts)
library(philentropy)
library(gplots)
library(dplyr)

```

## Objective 

In this script, we compare the clusters obtained from the HMP data (across all body supersites) on using admixture.
The idea is to see which clusters are close to eahc other, which is equivalent to saying which body supersites are close to each other. That can give an idea about the proportion of OTUs shared across different sites.

## Data preparation

We first prepare the HMP data for applying admixture to it

```{r data_load, echo=TRUE, eval=TRUE}
setwd('/Users/kushal/Documents/metagenomics/project/hands_HMP/')
load('../../data/HMPvs35_nt100_MRexperiment.rdata')
data <- t(MRcounts(hmp));
metadata <- pData(hmp);
otu_data <- featureData(hmp)
```


## Admixture by body supersite

We apply admixture on the full data grouped by the body supersite

```{r echo=TRUE, eval=TRUE}

full_data <- data;
metadata <- pData(hmp);
type_bodysite <- metadata$HMPbodysupersite;
structure_body_metagenome <- function(counts_data,type_info,K)
{
#  Topic_Clus <- topics(counts_data,K,tol=0.01);
#  write.table(Topic_Clus$omega,paste0('internal_data/body_data/topics_omega_',K,'.txt'));
#  write.table(Topic_Clus$theta,paste0('internal_data/body_data/topics_theta_',K,'.txt'));
  docweights <- as.matrix(read.table(paste0('../internal_data/body_data/topics_omega_',K,'.txt')));
  
  type_ordered <- type_info[order(type_info)];
  docweights_ordered <- docweights[order(type_info),];
  barplot(t(docweights_ordered),col=2:(K+1),axisnames=F,space=0,border=NA,main=paste("No. of clusters=",K),las=1,ylim=c(0,1),cex.axis=0.3,cex.main=1.4);
  labels = match(unique(type_ordered), type_ordered);
  abline(v=labels-1)

  labels_low=labels-1;
  labels_up=c(labels_low[2:length(labels_low)],dim(docweights_ordered)[1]);
  mid_point <- labels_low +0.5*(labels_up-labels_low);
  axis(1,at=mid_point, unique(type_ordered),las=2,cex.axis=0.3);
}

lapply(c(3,5,7), function(n) structure_body_metagenome(full_data,type_bodysite,n));


```

## Admixture by body subsite

We apply admixture on the full data grouped by the body supersite

```{r echo=TRUE, eval=TRUE}

full_data <- data;
metadata <- pData(hmp);
type_bodysite <- metadata$HMPbodysubsite;
structure_body_metagenome <- function(counts_data,type_info,K)
{
#  Topic_Clus <- topics(counts_data,K,tol=0.01);
#  write.table(Topic_Clus$omega,paste0('internal_data/body_data/topics_omega_',K,'.txt'));
#  write.table(Topic_Clus$theta,paste0('internal_data/body_data/topics_theta_',K,'.txt'));
  docweights <- as.matrix(read.table(paste0('../internal_data/body_data/topics_omega_',K,'.txt')));
  
  type_ordered <- type_info[order(type_info)];
  docweights_ordered <- docweights[order(type_info),];
  barplot(t(docweights_ordered),col=2:(K+1),axisnames=F,space=0,border=NA,main=paste("No. of clusters=",K),las=1,ylim=c(0,1),cex.axis=0.3,cex.main=1.4);
  labels = match(unique(type_ordered), type_ordered);
  abline(v=labels-1)

  labels_low=labels-1;
  labels_up=c(labels_low[2:length(labels_low)],dim(docweights_ordered)[1]);
  mid_point <- labels_low +0.5*(labels_up-labels_low);
  axis(1,at=mid_point, unique(type_ordered),las=2,cex.axis=0.3);
}

lapply(c(3,5,7), function(n) structure_body_metagenome(full_data,type_bodysite,n));

```


## Cluster comparison

We can try to see how closely related the different tissues and the different clusters are to one another. First we do a cluster comparison, by finding correlation of abundance patterns (the distribution of $\theta$ values across OTUs). We do it for $K=7$.

```{r echo=TRUE, eval=TRUE}
K <- 7
theta_topics <- t(as.matrix(read.table(paste0('../internal_data/body_data/topics_theta_',K,'.txt'))));

## KL divergence of the different clusters 

out <- distance(theta_topics, method="kullback-leibler")

#barplot(1:K,col=2:(K+1))

rownames(out) <-  c("red", "green", "blue", "cyan", "pink", "yellow", "gray");
colnames(out) <- rownames(out)

heatmap.2(out, col=c(rgb(seq(0,1,length=5),1,seq(0,1,length=5)),
                                rgb(1,seq(1,0,length=5),seq(1,0,length=5))
                                 ),
          key=T, keysize=1.5,
          density.info="none", trace="none", cexCol=0.8, cexRow=0.8)

```

## Supersite and Subsite comparison 

We now do the same comaprison at the tissue level instead of the cluster level. 

```{r echo=TRUE, eval=TRUE}

K <- 7
omega_topics <- as.matrix(read.table(paste0('../internal_data/body_data/topics_omega_',K,'.txt')));

tissue_expr <- omega_topics %*% theta_topics;
names(metadata$HMPbodysupersite) <- "supersite"
tissue_expr.frame <- cbind.data.frame(metadata$HMPbodysupersite, as.matrix(tissue_expr));
colnames(tissue_expr.frame)[1] <- "supersite"
site_expr.tbl <- tissue_expr.frame %>% group_by(supersite) %>% summarise_each(funs(mean))
site_expr.frame <- data.frame(site_expr.tbl, row.names=1);

out <- distance(site_expr.frame, method="kullback-leibler")
rownames(out) <- as.vector(site_expr.tbl$supersite);
colnames(out) <- rownames(out)

heatmap.2(out, col=c(rgb(seq(0,1,length=5),1,seq(0,1,length=5)),
                                rgb(1,seq(1,0,length=5),seq(1,0,length=5))
                                 ),
          key=T, keysize=1.5,
          density.info="none", trace="none",cexCol=0.8, cexRow=0.8)

tissue_expr.frame <- cbind.data.frame(metadata$HMPbodysubsite, as.matrix(tissue_expr));
colnames(tissue_expr.frame)[1] <- "subsite"
site_expr.tbl <- tissue_expr.frame %>% group_by(subsite) %>% summarise_each(funs(mean))
site_expr.frame <- data.frame(site_expr.tbl, row.names=1);

out <- distance(site_expr.frame, method="kullback-leibler")
rownames(out) <- as.vector(site_expr.tbl$subsite);
colnames(out) <- rownames(out)

heatmap.2(out, col=c(rgb(seq(0,1,length=5),1,seq(0,1,length=5)),
                                rgb(1,seq(1,0,length=5),seq(1,0,length=5))
                                 ),
          key=T, keysize=1.5,
          density.info="none", trace="none",cexCol=0.8, cexRow=0.8)

```

